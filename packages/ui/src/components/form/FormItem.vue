<script setup lang="ts">
import type { Size } from "../../utils/types.ts";
import FormEntry from "./FormEntry.vue";
import { useForm } from "../../utils/form.ts";
import * as yup from "yup";
import { computed, type ComputedRef, provide, watch } from "vue";

const props = defineProps<{
  schema?: yup.Schema;
  validationTrigger?: "input" | "change" | "blur";
  width?: number | "fit";
  labelPos?: "left" | "right" | "top";
  parser?: (value: any) => any;
  size?: Size;
}>();

type EventData = {
  value: any;
  reset: () => void;
  validate: () => Promise<boolean>;
  error: ComputedRef<string | null>;
};

defineEmits<{
  (e: "change", data: EventData, event: Event): void;
  (e: "input", data: EventData, event: Event): void;
  (e: "blur", data: EventData, event: Event): void;
  (e: "focus", data: EventData, event: Event): void;
  (e: "validated", data: EventData, event: Event): void;
}>();

const model = defineModel<any>({
  required: true,
});

const form = useForm(
  {
    value: model.value,
  },
  yup.object({
    value: props.schema ?? yup.mixed(),
  }),
  props.validationTrigger,
);

const field = form.__getField__("value");

watch(field.value, (value) => {
  if (value != model.value) model.value = value;
});

watch(model, (value) => {
  if (value != field.value.value) field.value.value = value;
});

const data = computed(() => ({
  value: field.value.value,
  reset: form.reset,
  validate: form.validate,
  error: field.error,
}));

provide("form", form);

defineExpose({
  reset: form.reset,
  validate: form.validate,
  error: field.error,
});
</script>

<template>
  <FormEntry
    name="value"
    :label-pos="labelPos"
    :parser="parser"
    :size="size"
    @input="$emit('input', data, $event)"
    @change="$emit('change', data, $event)"
    @focus="$emit('focus', data, $event)"
    @blur="$emit('blur', data, $event)"
    @validated="$emit('validated', data, $event)"
  >
    <slot />
  </FormEntry>
</template>

<style scoped lang="scss"></style>
